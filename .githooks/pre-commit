#!/usr/bin/env bash
set -e

# 1) Obtener s√≥lo los .yml/.yaml de workflows modificados
files=$(git diff --cached --name-only --diff-filter=ACM \
  | grep -E '^\.github/workflows/.*\.ya?ml$' || true)
[ -z "$files" ] && exit 0

echo "üîç Validando GitHub Actions YAML‚Ä¶"
fail=0

for f in $files; do
  echo " ‚Ä¢ Procesando $f"

  # 2) Limpieza: espacios al final de l√≠nea
  sed -i '' -E 's/[[:blank:]]+$//' "$f"
  # 3) Asegurar salto de l√≠nea final
  [ -n "$(tail -c1 "$f")" ] && printf "\n" >> "$f"
  # 4) Re-agregar al √≠ndice (staging)
  git add "$f"

  # 5) Lint YAML (desactivamos line-length y truthy)
  yamllint -d "{extends: default, rules: {line-length: disable, truthy: disable}}" "$f" || fail=1

  # 6) Lint espec√≠fico de GH Actions
  actionlint "$f" || fail=1
done

if [ $fail -ne 0 ]; then
  echo "‚ùå Hay errores en los workflows. Corr√≠gelos antes de commitear."
  exit 1
fi

exit 0